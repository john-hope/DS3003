---
title: "Assignment 13 - Shiny and Maps (4 pts)"
author: "Group 1, John Hope (jah9kqn)"
date: "Due Date: 11:59pm, Apr 4"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: hide
runtime: shiny    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE)
options(tigris_use_cache = TRUE)
library(tidyverse)
library(dplyr)
library(shiny)
library(shinythemes)
library(tigris)
library(tmaptools)
library(tmap)
library(sf)
```

# Part 1

```{r}
# Read data
covid <-read.csv("WHO-COVID-19-global-table-data.csv", header = TRUE)

# Rename columns
covid <-covid %>% 
  rename(Country=Name, 
         Deaths=Deaths...cumulative.total, 
         Cases=Cases...cumulative.total)

# Fix column names
names(covid)[1:(ncol(covid)-1)] <- names(covid)[2:ncol(covid)]
covid[, ncol(covid)] <- NULL

# Bind country names with rest of data
covid <- cbind(Country = rownames(covid), covid)
rownames(covid) <- 1:nrow(covid)

# Filter for countries and regions and create rates/SE
covid_countries <- covid %>% 
  filter(WHO.Region %in% c("Americas", "Europe", "Africa"))%>%
  filter(Country %in% c("Algeria","Congo","Liberia","Mexico","Canada",
                        "United States of America","France","Germany",
                        "Italy")) %>%
  mutate(rate=round((Deaths)/(Cases),digits = 2),SE= sqrt(rate*(1-rate)/(Cases)))

# Create UI with tabpanels for selected each region
ui <- navbarPage(title = "Mortality Rate", theme = shinytheme("united"),
      tabPanel("Africa", plotOutput("africaplot"),
               checkboxInput("error_checkbox",label="Show Error Bars",value=FALSE)), 
      tabPanel("Americas",plotOutput("americaplot"),
               radioButtons("error_radio",label = h3("Show Error Bars"),
                            choices = list("Yes"=1,"No"=2),
                            selected = 2),), 
      tabPanel("Europe", plotOutput("europeplot"),
               selectInput("error_select",label = h3("Show Error Bars"),
                           choices = list("Yes"=1,"No"=2),selected = 2),)
      )

# Create the server to create bar plots for selected region 
server = function(input, output){
    output$africaplot <- renderPlot({
      csubset<-covid_countries %>% filter(WHO.Region=="Africa")
      p1<-ggplot(csubset, aes(x=Country, y=rate)) + 
        geom_bar(position=position_dodge(), stat="identity", colour="black") +
        labs(x="Country", y="Mortality Rate", title="WHO Region: Africa") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        theme_minimal() + scale_y_continuous(limits = c(0, 0.05))
    print(p1)
    
    # Adds error bars if checked
    if (input$error_checkbox){
    p1e<-p1+geom_errorbar(aes(ymin=rate-1.96*SE, ymax=rate+1.96*SE), width=.2,
                 position=position_dodge(.9))
    print(p1e)
      
    }
    })
    
    output$americaplot <- renderPlot({
      csubset<-covid_countries %>% filter(WHO.Region=="Americas")
      p1<-ggplot(csubset, aes(x=Country, y=rate)) + 
        geom_bar(position=position_dodge(), stat="identity", colour="black") +     
        labs(x="Country", y="Mortality Rate", title="WHO Region: Americas") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        theme_minimal() + scale_y_continuous(limits = c(0,0.1))
      print(p1)
      
    # Add error bars
    if (input$error_radio == 1){
    p1e<-p1+geom_errorbar(aes(ymin=rate-1.96*SE, ymax=rate+1.96*SE), width=.2,
                 position=position_dodge(.9))
    print(p1e)
      
    }

    })
    
    output$europeplot <- renderPlot({
      csubset<-covid_countries %>% filter(WHO.Region=="Europe")
      p1<-ggplot(csubset, aes(x=Country, y=rate)) + 
        geom_bar(position=position_dodge(), stat="identity", colour="black") +     
        labs(x="Country", y="Mortality Rate", title="WHO Region: Europe") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        theme_minimal() + scale_y_continuous(limits = c(0, 0.035))
      print(p1)
      
    # Add error bars
    if (input$error_select == 1){
    p1e<-p1+geom_errorbar(aes(ymin=rate-1.96*SE, ymax=rate+1.96*SE), width=.2,
                 position=position_dodge(.9))
    print(p1e)
      
    }
    })
    
    }

# Create shiny app
shinyApp(ui = ui, server = server, options = list(height = 1000))
```

# Part 2

The dataset used for this part consists of minimum wage data for each state in the U.S.. The dataset was collected on Kaggle, and can be found at https://www.kaggle.com/datasets/lislejoem/us-minimum-wage-by-state-from-1968-to-2017 . The data consists of state and federal minimum wages each year from 1968 to 2020, with each row representing a year and state/territory. Using this dataset, we can create a map of minimum wages across the country for the year 2020, to see which states have higher or lower minimum wages.

```{r, warning=FALSE, message=FALSE}
# Read data
wages <- read.csv("Minimum Wage Data.csv")

# Filter to 2020 and get rid of unnecessary observations
wages2020 <- wages %>% filter(Year == 2020) %>%
  filter(!State %in% c("Guam", "Hawaii", "Alaska", "U.S. Virgin Islands", "Puerto Rico"))

# Making the minimum wage at least 7.25 (federal)
wages2020$State.Minimum.Wage[wages2020$State.Minimum.Wage < 7.25] <- 7.25 

# Reading in state data for mapping
download.file("http://www2.census.gov/geo/tiger/GENZ2015/shp/cb_2015_us_state_20m.zip", destfile = "states.zip")
unzip("states.zip")
usmap <- st_read("cb_2015_us_state_20m.shp", stringsAsFactors = FALSE)

# Joining the mapping data with wage data
usdata <- inner_join(usmap, wages2020, by=c("NAME" = "State"))

# Create the UI witht tmap output
ui <- fluidPage(
  tmapOutput('minWageMap')
)

# Create the server to render the tmap for state mimimum wage data
server <- function(input, output){
  
  output$minWageMap <- renderTmap({
    
    tm_shape(usdata) + 
      tm_polygons("State.Minimum.Wage", id="NAME", palette = "Greens", title = "Minimum Wage by State")
    
    })
  
  tmap_mode("view")
  tmap_last()
  
  }

# Create shiny APP
shinyApp(ui = ui, server = server)
```

Our map shows that the vast majority of states go by the federal minimum wage of 7.25/hour. Some states like California, Washington, and Maine stand out with high wages, all over 12/hour. DC is also hard to see on this map but has a minimum wage of 14/hour. This map is a little outdated though, for example Virginia increased its minimum wages from 7.25 in 2020 to 9.50 in 2021 and 11 in 2022. We are unsure about the specifics of other states, but it is likely that many states increased their minimum wages during the pandemic.

